function createCase(){Microsoft.CIFramework.getFocusedSession().then(n=>{var o,s;if(sessionslist.sessionmap){var t=sessionslist.sessionmap.get(n),i=null,r=null,f=null,e=null,u=null;if(t!=null||t!=undefined){if(o=t._number,!o)return reject("number is empty");t.contactrecordAvailable?(t._languageId!=null&&t._languageName!=null&&(i=t._languageId,r=t._languageName),t._companyId!=null&&t._companyName!=null&&(f=t._companyId,e=t._companyName),t._name!=null&&t._name!=undefined&&t._name.toString().toUpperCase()!="UNKNOWN"&&(u=t._name)):t.contactrecordAvailable||t._caseContactLanguageId==null||t._caseConLanguageName==null||(i=t._caseContactLanguageId,r=t._caseConLanguageName,t._caseContactName!=null&&t._caseContactName.trim().toUpperCase()!="UNKNOWN"&&(u=t._caseContactName.trim()));s={templateName:"msdyn_entityrecord",templateParameters:{entityName:"incident",entityId:"",data:{jarvis_callernameargus:u,jarvis_callerphone:t.ExactCallingPartyNumber,jarvis_callerlanguage:i,jarvis_callerlanguagename:r,jarvis_callercompany:f,jarvis_callercompanyname:e}},isFocused:!0};Microsoft.CIFramework.createTab(s)}}})}function onSessionSwitchHandler(n){(Microsoft.CIFramework.setWidth(300),n!=null&&n!=undefined)&&Microsoft.CIFramework.getFocusedSession().then(function(n){var i,t;if(console.log(n),i=n,console.log(this.sessionslist.sessionmap),this.sessionslist.sessionmap){if(t=sessionslist.sessionmap.get(i),t!=null||t!=undefined){t.contactrecordAvailable&&(t._name!=null||t._name!=undefined)?(console.log(t._name),$(".callerName").text(t._name)):t.contactrecordAvailable||t._caseContactName==null&&t._caseContactName==undefined?$(".callerName").text("Unknown"):(console.log(t._caseContactName),$(".callerName").text(t._caseContactName.trim()));t.contactrecordAvailable&&(t._companyName!=null||t._companyName!=undefined)?(console.log(t._companyName),$(".companyName").text(t._companyName)):t.contactrecordAvailable||t._caseContactCompanyName==null&&t._caseContactCompanyName==undefined?$(".companyName").text("Unknown"):(console.log(t._caseContactCompanyName),$(".companyName").text(t._caseContactCompanyName));return}$(".callerName").text("Unknown");$(".companyName").text("Unknown");return}$(".callerName").text("Unknown");$(".companyName").text("Unknown");return},function(n){console.log(n.message)})}function onSessionSwitchHandler2(){}function setPanelMode(n){Microsoft.CIFramework.setMode(n).then(function(n){log("Successfully set the panel mode "+n)}).catch(function(n){log("Failed to set mode due to: "+n)})}function log(n){n=(new Date).toString()+" "+n;console.log(n)}function createagentsession(n){var t=n.CallingPartyNumber,f=n.CallID,e=n.CalledNumber,o=n.Instance,s=n.ServiceGroup,i=n.siteId,r=n.userId,u={templateName:"sample_CallSessionTemplate",templateParameters:{customer:t}};Microsoft.CIFramework.createSession(u).then(n=>{var u=new SessionInfo;if(u.userId=r,u.siteId=i,u.ExactCallingPartyNumber=t,t){let n=/^\+/.test(t),i=/^00/.test(t),r=/^0/.test(t);n?t=t.replace(/^\+/g,""):i?t=t.replace(/^00/,""):r&&(t=t.replace(/^0/,""))}Utility.openRelatedRecord(t);Utility.openContactRecord(t,!1,u,n);Utility.openBusinessPartnerRecord(t,!1,u);Utility.openCaseRecord(t,!1,u);Utility.openCaseContactRecord(t,!1,u)},()=>{})}function clickToActHandler(n){return new Promise(function(t,i){try{let i=JSON.parse(n);getphonePrefix(i);t(!0)}catch(r){i(r)}})}function showErrorNotification(n){var t={type:2,level:3,message:n,showCloseButton:!0};Microsoft.CIFramework.showGlobalNotification(t).then(function(){},function(n){console.log(n.message)})}function showToastNotification(n,t,i,r){systemuserid=i.replace("{","").replace("}","");var u={title:n,body:t,"ownerid@odata.bind":"/systemusers("+systemuserid+")",icontype:r,toasttype:2e8,ttlinseconds:60},f=JSON.stringify(u);Microsoft.CIFramework.createRecord("appnotification",f).then(function(){},function(n){console.log(n.message)})}function openEntityRecord(n,t,i){var r={templateName:n,templateParameters:{entityName:t,entityId:i}};Microsoft.CIFramework.createTab(r)}function getphonePrefix(n){var i=n.entityLogicalName,r=n.name,u=n.entityId,t=n.value;Microsoft.CIFramework.getEnvironment().then(function(n){var f=JSON.parse(n).userId,e="?$select=_siteid_value&$filter=(systemuserid eq "+f+")";Microsoft.CIFramework.searchAndOpenRecords("systemuser",e,!0).then(function(n){var e=JSON.parse(n),f,o,s;e[0]!=null&&(f=e[0]._siteid_value);i=="incident"?(o="?$select=_jarvis_callercompany_value,_jarvis_homedealer_value,_jarvis_caseserviceline_value,jarvis_callerphone,jarvis_driverphone&$filter=(incidentid eq "+u+")",Microsoft.CIFramework.searchAndOpenRecords(i,o,!0).then(function(n){var i=JSON.parse(n),e,u;if(i[0]!=null){var o=i[0]._jarvis_callercompany_value,s=i[0]._jarvis_homedealer_value,h=i[0]._jarvis_caseserviceline_value;r=="jarvis_callerphone"?o!=null?(t=i[0].jarvis_callerphone,e="?$select=_jarvis_country_value,_jarvis_address1_country_value&$filter=(accountid eq "+o+")",Microsoft.CIFramework.searchAndOpenRecords("account",e,!0).then(function(n){var i=JSON.parse(n),r,u;i[0]!=null?(r=i[0]._jarvis_country_value,i[0]._jarvis_country_value==null&&(r=i[0]._jarvis_address1_country_value),r!=null?(u="?$select=jarvis_prefix&$filter=(_jarvis_serviceline_value eq "+h+") and (_jarvis_site_value eq "+f+") and (_jarvis_country_value eq "+r+")",Microsoft.CIFramework.searchAndOpenRecords("jarvis_phoneprefix",u,!0).then(function(n){var i=JSON.parse(n);i[0]!=null&&i[0].jarvis_prefix!=undefined&&i[0].jarvis_prefix!=null?placeCallWithPrefix(i[0].jarvis_prefix,t):placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t)):placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t):r=="jarvis_driverphone"&&(s!=null?(e="?$select=_jarvis_country_value,_jarvis_address1_country_value&$filter=(accountid eq "+s+")",u=null,t=i[0].jarvis_driverphone,Microsoft.CIFramework.searchAndOpenRecords("account",e,!0).then(function(n){var i=JSON.parse(n),r;i[0]!=null?(u=i[0]._jarvis_country_value!=null?i[0]._jarvis_country_value:i[0]._jarvis_address1_country_value,u!=null?(r="?$select=jarvis_prefix&$filter=(_jarvis_serviceline_value eq "+h+") and (_jarvis_site_value eq "+f+") and (_jarvis_country_value eq "+u+")",Microsoft.CIFramework.searchAndOpenRecords("jarvis_phoneprefix",r,!0).then(function(n){var i=JSON.parse(n);i[0]!=null&&i[0].jarvis_prefix!=undefined&&i[0].jarvis_prefix!=null?placeCallWithPrefix(i[0].jarvis_prefix,t):placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t)):placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t))}else placeCallWithoutPrefix(t)})):i=="jarvis_casecontact"?(s="?$select=_jarvis_incident_value,jarvis_mobilephone,jarvis_phone,jarvis_role&$filter=(jarvis_casecontactid eq "+u+")",Microsoft.CIFramework.searchAndOpenRecords(i,s,!0).then(function(n){var i=JSON.parse(n),u,e,o;i[0]!=null&&i[0]._jarvis_incident_value!=null&&i[0].jarvis_mobilephone!=null&&i[0].jarvis_role!=null?(u=i[0]._jarvis_incident_value,e=i[0].jarvis_role,r=="jarvis_mobilephone"?t=i[0].jarvis_mobilephone:r=="jarvis_phone"&&(t=i[0].jarvis_phone),o="?$select=_jarvis_callercompany_value,_jarvis_homedealer_value,_jarvis_caseserviceline_value&$filter=(incidentid eq "+u+")",Microsoft.CIFramework.searchAndOpenRecords("incident",o,!0).then(function(n){var i=JSON.parse(n),o;if(i[0]!=null){var r=i[0]._jarvis_callercompany_value,u=i[0]._jarvis_homedealer_value,s=i[0]._jarvis_caseserviceline_value;r!=null||u!=null?(accountFilter=e==334030001?r:u,o="?$select=_jarvis_country_value,_jarvis_address1_country_value&$filter=(accountid eq "+accountFilter+")",Microsoft.CIFramework.searchAndOpenRecords("account",o,!0).then(function(n){var i=JSON.parse(n),r,u;i[0]!=null?(r=i[0]._jarvis_country_value,i[0]._jarvis_country_value==null&&(r=i[0]._jarvis_address1_country_value),r!=null?(u="?$select=jarvis_prefix&$filter=(_jarvis_serviceline_value eq "+s+") and (_jarvis_site_value eq "+f+") and (_jarvis_country_value eq "+r+")",Microsoft.CIFramework.searchAndOpenRecords("jarvis_phoneprefix",u,!0).then(function(n){var i=JSON.parse(n);i[0]!=null&&i[0].jarvis_prefix!=undefined&&i[0].jarvis_prefix!=null?placeCallWithPrefix(i[0].jarvis_prefix,t):placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t)):placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t)}else placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t)})):placeCallWithoutPrefix(t)})})}function placeCallWithPrefix(n,t){t=t.replace(/\s/g,"");t=t.replace("+","00");callto=n+t;window.open("tel:"+callto)}function placeCallWithoutPrefix(n){n=n.replace(/\s/g,"");n=n.replace("+","00");callto=n;window.open("tel:"+callto)}class Utility{static openRelatedRecord(n){return new Promise(function(t,i){if(!n)return i("number is empty");var r={templateName:"msdyn_ContactList",templateParameters:{searchText:n},isFocused:!0};Microsoft.CIFramework.createTab(r).then(n=>{console.log("created tab with id "+n),t({value:n,isNameFound:!0})},n=>(console.log(n),t("Related Record is not opened")))})}static openContactRecord(n,t,i,r,u){return new Promise(function(f,e){if(!n)return e("number is empty");i._number=n;log("Trying to find name of caller "+n+" with searchOnly="+t);var o="?$select=fullname,_jarvis_language_value&$expand=parentcustomerid_account($select=name),jarvis_Language($select=jarvis_languageid,jarvis_name)&$filter=";o+=u?"contactid eq "+u:"(contains(mobilephone,'"+encodeURIComponent(n)+"') or contains(company,'"+encodeURIComponent(n)+"'))";Microsoft.CIFramework.searchAndOpenRecords("contact",o,!0).then(function(t){try{let n=JSON.parse(t);typeof n!="object"||n[1]==undefined?typeof n!="object"||n[1]!=undefined||n[0]==undefined?(i.contactrecordAvailable=!1,i.renderCallerName()):(openEntityRecord("msdyn_entityrecord","contact",n[0].contactid),i&&(i._name=n[0].fullname!=null?n[0].fullname:null,i._contactid=n[0].contactid,i.contactrecordAvailable=!0,n[0].parentcustomerid_account&&(i._companyName=n[0].parentcustomerid_account.name!=null?n[0].parentcustomerid_account.name:null,i._companyId=n[0].parentcustomerid_account.accountid),n[0].jarvis_Language&&(i._languageName=n[0].jarvis_Language.jarvis_name!=null?n[0].jarvis_Language.jarvis_name:null,i._languageId=n[0].jarvis_Language.jarvis_languageid),log("The caller name is "+n[0].fullname),i.renderCallerName())):i&&(i.recordAvailable=!0,i._name=n[0].fullname!=null?n[0].fullname:null,i._contactid=n[0].contactid,i.contactrecordAvailable=!0,n[0].parentcustomerid_account&&(i._companyName=n[0].parentcustomerid_account.name!=null?n[0].parentcustomerid_account.name:null,i._companyId=n[0].parentcustomerid_account.accountid),n[0].jarvis_Language&&(i._languageName=n[0].jarvis_Language.jarvis_name!=null?n[0].jarvis_Language.jarvis_name:null,i._languageId=n[0].jarvis_Language.jarvis_languageid),log("The caller name is "+n[0].fullname),i.renderCallerName());sessionslist.sessionmap.set(r,i);f({value:n[0].fullname,isNameFound:!0})}catch(u){log("Unable to find caller name- Exception: "+u);f({value:n,isNameFound:!1})}}).catch(function(t){t||(t="Unknown Reason");log("Couldn't retrieve caller name because "+t.toString());f({value:n,isNameFound:!1})})})}static openBusinessPartnerRecord(n,t,i){return new Promise(function(t,r){if(!n)return r("number is empty");var u="?$select=name,accountid&$filter=contains(telephone1, '"+encodeURIComponent(n)+"')";Microsoft.CIFramework.searchAndOpenRecords("account",u,!0).then(function(r){try{let n=JSON.parse(r);log("Account DATA----------------------------------------");log(r);!typeof n!="object"||n[1]==undefined?typeof n!="object"||n[1]!=undefined||n[0]==undefined?i.accountrecordAvailable=!1:(openEntityRecord("msdyn_entityrecord","account",n[0].accountid),i.accountrecordAvailable=!0):i.recordAvailable=!0;t({value:n[0].name,isNameFound:!0})}catch(u){log("Unable to find BusinessParter name- Exception: "+u);t({value:n,isNameFound:!1})}}).catch(function(i){i||(i="Unknown Reason");log("Couldn't retrieve BusinessParter because "+i.toString());t({value:n,isNameFound:!1})})})}static openCaseRecord(n,t,i){return new Promise(function(t,r){if(!n)return r("number is empty");var u="?$select=title,incidentid,jarvis_callerphone,jarvis_driverphone&$filter=((contains(jarvis_callerphone,'"+encodeURIComponent(n)+"') or contains(jarvis_driverphone,'"+encodeURIComponent(n)+"') or contains(jarvis_callerfixedphone,'"+encodeURIComponent(n)+"')) and statecode eq 0)";Microsoft.CIFramework.searchAndOpenRecords("incident",u,!0).then(function(r){try{let n=JSON.parse(r);log("Case DATA-------------------------------------------------");log(r);typeof n!="object"||n[1]==undefined?typeof n!="object"||n[1]!=undefined||n[0]==undefined?i.caserecordAvailable=!1:(openEntityRecord("msdyn_entityrecord","incident",n[0].incidentid),i.caserecordAvailable=!0):i.recordAvailable=!0;t({value:n[0].title,isNameFound:!0})}catch(u){log("Unable to find Incident name- Exception: "+u);t({value:n,isNameFound:!1})}}).catch(function(i){i||(i="Unknown Reason");log("Couldn't retrieve BusinessParter because "+i.toString());t({value:n,isNameFound:!1})})})}static openCaseContactRecord(n,t,i){return new Promise(function(t,r){if(!n)return r("number is empty");var u="?$select=jarvis_firstname,jarvis_lastname,jarvis_businesspartner,jarvis_casecontactid,_jarvis_incident_value,jarvis_mobilephone,jarvis_phone&$expand=jarvis_PreferredLanguage($select=jarvis_languageid,jarvis_name)&$filter=(contains(jarvis_mobilephone,'"+encodeURIComponent(n)+"') or contains(jarvis_phone,'"+encodeURIComponent(n)+"'))";Microsoft.CIFramework.searchAndOpenRecords("jarvis_casecontact",u,!0).then(function(r){try{let n=JSON.parse(r);log("Case Contact DATA-------------------------------------------------");log(r);typeof n!="object"||n[1]==undefined?typeof n!="object"||n[1]!=undefined||n[0]==undefined?(i.caseContactRecordAvailable=!1,i.renderCallerName()):(openEntityRecord("msdyn_entityrecord","jarvis_casecontact",n[0].jarvis_casecontactid),i&&(i._multipleCaseConAvailable=!1,i.caseContactRecordAvailable=!0,i._caseContactName=n[0].jarvis_firstname!=null&&n[0].jarvis_firstname!=undefined||n[0].jarvis_lastname!=null&&n[0].jarvis_lastname!=undefined?(n[0].jarvis_firstname!=null?n[0].jarvis_firstname:"")+" "+(n[0].jarvis_lastname!=null?n[0].jarvis_lastname:""):null,i._caseContactId=n[0].jarvis_casecontactid,i._caseContactCompanyName=n[0].jarvis_businesspartner!=null||n[0].jarvis_businesspartner!=undefined?n[0].jarvis_businesspartner:null,n[0].jarvis_PreferredLanguage&&(i._caseConLanguageName=n[0].jarvis_PreferredLanguage.jarvis_name!=null||n[0].jarvis_PreferredLanguage.jarvis_name!=undefined?n[0].jarvis_PreferredLanguage.jarvis_name:null,i._caseContactLanguageId=n[0].jarvis_PreferredLanguage.jarvis_languageid),i.renderCallerName())):i&&(i.recordAvailable=!0,i._multipleCaseConAvailable=!0,i.caseContactRecordAvailable=!0,i._caseContactName=n[0].jarvis_firstname!=null&&n[0].jarvis_firstname!=undefined||n[0].jarvis_lastname!=null&&n[0].jarvis_lastname!=undefined?(n[0].jarvis_firstname!=null?n[0].jarvis_firstname:"")+" "+(n[0].jarvis_lastname!=null?n[0].jarvis_lastname:""):null,i._caseContactId=n[0].jarvis_casecontactid,i._caseContactCompanyName=n[0].jarvis_businesspartner!=null||n[0].jarvis_businesspartner!=undefined?n[0].jarvis_businesspartner:null,n[0].jarvis_PreferredLanguage&&(i._caseConLanguageName=n[0].jarvis_PreferredLanguage.jarvis_name!=null||n[0].jarvis_PreferredLanguage.jarvis_name!=undefined?n[0].jarvis_PreferredLanguage.jarvis_name:null,i._caseContactLanguageId=n[0].jarvis_PreferredLanguage.jarvis_languageid),i.renderCallerName());t({value:n[0].title,isNameFound:!0})}catch(u){log("Unable to find Case Contact name- Exception: "+u);t({value:n,isNameFound:!1})}}).catch(function(i){i||(i="Unknown Reason");log("Couldn't retrieve Case Contact because "+i.toString());t({value:n,isNameFound:!1})})})}}class SessionList{constructor(){this.sessionmap=new Map}}class SessionInfo{constructor(){this._name=null;this._number=null;this.caserecordAvailable=!1;this.accountrecordAvailable=!1;this.contactrecordAvailable=!1;this.caseContactRecordAvailable=!1;this._multipleContactAvailable=!1;this._multipleCaseConAvailable=!1;this._companyName=null;this._companyId=null;this._languageId=null;this._languageName=null;this._caseContactId=null;this._caseContactName=null;this._caseContactCompanyName=null;this._caseContactCompanyId=null;this._caseContactLanguageId=null;this._caseConLanguageName=null;this.siteId=null;this.userId=null;this.ExactCallingPartyNumber=null}get name(){return this._name?this._name:this._number}renderCallerName(){var n=this.name,i,t;this.contactrecordAvailable&&(this._name!=null||this._name!=undefined)?($(".callerName").text(this._name),n=this._name):!this.contactrecordAvailable&&this.caseContactRecordAvailable&&(this._caseContactName!=null||this._caseContactName!=undefined)?($(".callerName").text(this._caseContactName.trim()),n=this._caseContactName.trim()):$(".callerName").text("Unknown");this.contactrecordAvailable&&(this._companyName!=null||this._companyName!=undefined)?$(".companyName").text(this._companyName.trim()):!this.contactrecordAvailable&&this.caseContactRecordAvailable&&(this._caseContactCompanyName!=null||this._caseContactCompanyName!=undefined)?$(".companyName").text(this._caseContactCompanyName):$(".companyName").text("Unknown");this.name||(n="Unknown("+this._number+")");i={sessionId:this.sessionId,customer:n};Microsoft.CIFramework.setSessionTitle(i);t=n.split(" ");$(".callerInit").text(t[0][0]+(t[1]?t[1][0]:t[0][1]))}set name(n){if(!n){this._name=this._number=null;return}n.startsWith("+")?(this._number=n,log("Initiated number lookup")):this._name=n}}$(function(){sessionslist=new SessionList;Microsoft.CIFramework.setClickToAct(!0);Microsoft.CIFramework.addHandler("onclicktoact",clickToActHandler);Microsoft.CIFramework.addHandler("onSessionSwitched",onSessionSwitchHandler)});